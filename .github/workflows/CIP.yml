name: Customer Intelligence GP Pipeline

on:
  push:
    branches: [ "customer-Intelligence-pipeline" ]
  workflow_dispatch:

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: üì¶ Install dependencies
        run: |
          echo -e "\033[1;34müì¶ Installing Python dependencies...\033[0m"
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: üöÄ Run Customer Intelligence GP pipeline
        run: |
          echo -e "\033[1;32müöÄ Running Customer Intelligence GP pipeline...\033[0m"
          python customer-Intelligence-pipeline/src/Customer-Intelligence-GP.py

      - name: üßπ Remove large model files before commit
        run: |
          echo -e "\033[1;33müßπ Removing .pkl model artifacts (too large for GitHub)...\033[0m"
          find outputs -type f -name "*.pkl" -delete || true

      - name: üïì Get current timestamp
        id: datetime
        run: echo "timestamp=$(date +'%Y%m%d_%H%M')" >> $GITHUB_OUTPUT

      - name: üìÅ Find latest output folder
        id: latest_output
        run: |
          latest=$(ls -td outputs/outputs_* | head -1)
          echo "latest_folder=$latest" >> $GITHUB_OUTPUT
          echo -e "\033[1;34müìÅ Latest output folder detected: $latest\033[0m"

      - name: üóÉÔ∏è Commit & push generated outputs (PNG, CSV, XLSX only)
        run: |
          echo -e "\033[1;35müóÉÔ∏è Preparing to archive new outputs...\033[0m"
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          timestamp="${{ steps.datetime.outputs.timestamp }}"
          latest="${{ steps.latest_output.outputs.latest_folder }}"
          archive_dir="outputs/archive_${timestamp}"

          mkdir -p "$archive_dir"
          echo -e "\033[1;36müì¶ Archiving outputs from: $latest -> $archive_dir\033[0m"

          # Copy Tableau-ready files (images, CSVs, Excel workbooks)
          find "$latest" -type f \( -name "*.png" -o -name "*.csv" -o -name "*.xlsx" \) -exec cp --parents {} "$archive_dir" \;

          echo -e "\033[1;32m‚úÖ Files copied successfully to archive.\033[0m"

          git add "$archive_dir" || true
          if git diff --cached --quiet; then
            echo -e "\033[1;33m‚ö†Ô∏è No new files to commit.\033[0m"
          else
            git commit -m "üìä Auto-commit: archived outputs at ${timestamp}"
            git push origin customer-Intelligence-pipeline
            echo -e "\033[1;32m‚úÖ Outputs successfully pushed to GitHub.\033[0m"
          fi
